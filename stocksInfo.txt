Что происходит в коде:

>решаем задачу оптимизационными методами
набор цен представляется ввиде функции f по которой ищется максимум  
   f(b1)-f(a1) + ... + f(bn)-b(an)
где a1 .. an - моменты покупки акций, b1 .. bn - моменты продаж,
производная в точке вычисляется на основе аппроксимации соседних двух точек из датасета линейной функцией

>Пишется функция возвращающая градиент функции прибыли

>Производится предобработка данных, выкидываются значения которые равны значению в предыдущий момент времени, так градиент не затухнет в таком месте.

>Дальше используется следующий оптимизационный метод:

По датасету градиентный спуск пытается найти максимум функции

Дальше данные сжимаются таким образом: остается только каждый ratio-ый элемент где ratio изначально заданное число

Таким образом мы теряем очень много информации, но с другой стороны избавляемся от неровностей в графике, что позволяет 
градиентному спуску лучше работать

После этого запускаем градиентный спуск по сжатым данным, обновляем лучший результат, дальше снова сжимаем, снова градиентный спуск
и так до того момента пока сжимать данные становится бесполезно.

Назовем совокупность процедур от град. спуска по полным данным до град спуска по макс. сжатым данным эпохой
Повторим несколько таких эпох, задавая начальные веса лучшим результатом на предыдущей эпохе, таким образом 
на полных данных град спуск лучше учтет глобальный рельеф графика и примерное нахождение оптимальных позиций, а также сможет улучшить за счет локальных изменений результат.

>После чего на основе полученных точек выдает ответ

